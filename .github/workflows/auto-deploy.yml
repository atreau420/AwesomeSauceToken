name: ğŸš€ Auto-Deploy AI Income Generator

on:
  push:
    branches: [ main, copilot/* ]
  pull_request:
    branches: [ main ]

jobs:
  deploy-income-generator:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout Code
      uses: actions/checkout@v4
      
    - name: âš¡ Setup Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        echo "âœ… Dependencies installed"
        
    - name: ğŸ§ª Run Tests (Income Features)
      run: |
        npm test
        echo "âœ… All income generation tests passed!"
        
    - name: ğŸ” Security Audit
      run: |
        npm audit --audit-level=moderate
        echo "âœ… Security check passed"
        
    - name: ğŸ—ï¸ Build for Production
      run: |
        npm run build:netlify
        echo "âœ… AI Marketplace built for production"
        
    - name: ğŸš€ Deploy to Netlify
      uses: nwtgck/actions-netlify@v2.0
      with:
        publish-dir: '.'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: |
          ğŸš€ AI Income Generator LIVE!
          ğŸ’° Revenue streams: Platform fees, Premium features, Dynamic pricing
          ğŸ¤– AI Features: Strategy generator, Fraud detection, Analytics
          â›“ï¸ Blockchain: Polygon mainnet integration
        enable-pull-request-comment: true
        enable-commit-comment: true
        overwrites-pull-request-comment: true
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        # Blockchain credentials for income generation
        PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
        POLYGON_RPC_URL: ${{ secrets.POLYGON_RPC_URL }}
        ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
        # AI & Revenue settings
        NODE_ENV: production
        AI_PRICING_ENABLED: true
        PLATFORM_FEE_BP: 150
        FEATURED_DAILY_RATE_ETH: 0.001
        SPONSORED_SLOT_RATE_ETH: 0.005
        
    - name: ğŸ‰ Deployment Success
      if: success()
      run: |
        echo "ğŸ‰ INCOME GENERATOR IS LIVE!"
        echo "ğŸ’° Revenue streams are now ACTIVE:"
        echo "   â€¢ Platform fees: 1.5% of all transactions"
        echo "   â€¢ Featured listings: Dynamic AI pricing"
        echo "   â€¢ Sponsored slots: Demand-based rates"
        echo "   â€¢ Premium AI features: Strategy generator"
        echo ""
        echo "ğŸ“Š Monitor your income at:"
        echo "   â€¢ Live site: https://your-site.netlify.app"
        echo "   â€¢ Analytics: Built-in AI dashboard"
        echo "   â€¢ Revenue tracking: Real-time metrics"
        
    - name: ğŸš¨ Deployment Failure Alert
      if: failure()
      run: |
        echo "ğŸš¨ DEPLOYMENT FAILED - Income generation delayed!"
        echo "ğŸ”§ Check logs above for issues"
        echo "ğŸ’¡ Common fixes:"
        echo "   â€¢ Verify secrets are set in GitHub"
        echo "   â€¢ Check Netlify auth token"
        echo "   â€¢ Ensure tests pass"
